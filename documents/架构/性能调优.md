[toc]

# 常用测试指标

- 响应时间

| 操作                        | 响应时间 |
| --------------------------- | -------- |
| 访问一个站点                | 几秒     |
| 数据库查询一条记录(有索引)  | 十几毫秒 |
| 机械磁盘一次寻址定位        | 4毫秒    |
| 机械磁盘顺序读取1M数据      | 2毫秒    |
| SSD顺序读取1M数据           | 0.3毫秒  |
| 远程分布式Redis读取一个数据 | 0.5毫秒  |
| 从内存中读取1M数据          | 十几微妙 |
| Java程序本地方法调用        | 几微妙   |
| 网络传输2Kb数据             | 1微妙    |

- 并发数

  同一时刻，对服务器有实际交互的请求数。

- 吞吐量

  单位时间内完成的工作量的量度。

# 常用性能优化手段

## 避免过早优化

## 进行系统性能测试

所有的性能调试，都有应该建立在性能测试的基础上。

## 分而治之

进行性能测试后，对整个请求经历的各个环节进行分析，排查出现性能瓶颈的地方，定位问题。

# 前端优化

## 浏览器/App

- 减少请求数

  - 合并请求

    合并业务上常用的ajax请求。

  - 合并css，js，图片。

    例如生产服务器提供all.js。

  - 开启Http 1.1 Keep-alive

- 使用客户端缓存

  - Cache-Control(相对时间)
  - Expires(绝对时间)

- 启用压缩

  对文件进行压缩，但是客户端与服务端要进行压缩与解压的操作，仅减少网络带宽的消耗。

  实际开发中需要对该点进行权衡。

- 资源文件加载顺序

  先加载css，再加载js。如果js中存在耗时的操作，那么浏览器将迟迟不加载css进行页面渲染。

- 减少Cookie传输

## CDN加速

内容分发网络。本质上是一个缓存：将数据缓存在最近的地方。

## 反向代理加速

将静态文件缓存在反向代理服务器上。

## Web组件分离

由于浏览器下载一个域名的数据存在并发数限制，所以将js，css和图片文件放在不同的域名下，以提高下载Web组件的并发数。

# 应用服务性能优化

## 缓存

- 基本原理与本质

  将数据访问放到高校介质中。

- 优化原则
  - 缓存离用户越近越好
- 使用原则
  - (缓存)读多写少，读写比例大于2:1。
  - 缓存一定是热点数据
  - 应用需要容忍一定时间的数据不一致
  - 缓存可用性问题，一般通过热备或者集群来解决

### 分布式缓存与一致性哈希

- 实现

  以集群方式提供缓存服务，通常有以下两种实现：

  1. 需要更新同步的分布式缓存，所有的服务器保存相同的缓存数据，带来的问题是缓存的数据量受到限制，其次数据要在所有机器上同步，代价很大。

  2. 每台机器只缓存一部分数据，然后通过一定的算法选择缓存服务器。常见的余数hash算法存在当有服务器上下线的时候，大量缓存数据重建的问题。

     故提`一致性哈希算法`：

     - 首先求出服务器（node）的哈希值，将其配置到0~2的32次方的环上

     - 采用相同方法求出存储数据的哈希值，将其映射到相同的环上

     - 从数据映射位置开始顺序查找，将数据保存到第一个服务器上。如果超过2^32仍然找不到服务器，就会保存到第一个服务器上。

- 数据倾斜

  如果服务器节点太少时，一致性哈希算法容易因为节点分布不均匀而造成数据倾斜问题。导致大量数据集中在NodeA，而极少数据定位到NodwB。

  为了解决数据倾斜问题，一致性哈希算法引入虚拟节点机制，即对每一个服务节点计算多个哈希值，每个计算结果位置都繁殖一个此服务节点，称为虚拟节点。

  例如为每台服务器计算三个数据节点，于是分别计算NodeA#1,NodeA#2,NodeA#3,NodeB#1,NodeB#2,NodeB#3，形成六个虚拟节点。

  在实际应用中，通常将虚拟节点数设置为32或者更大，因此即使很少的服务节点也能做到相对均匀的数据分布。

# 集群

将用户请求分配多个节点处理，对总体性能提升很大。

## 异步

- 常见异步手段

  - Servlet异步

    Servlet 3中才有，支持的web容器在tomcat7和jetty8以后。

## 多线程

## 消息队列

# 程序

## 代码级别

- 数据结构
- 算法
- 更少的代码

## 并发编程

## 资源服用

## 单例模式

## 池化技术

# 存储

- 使用SSD
- 定时清理
- 结果集处理